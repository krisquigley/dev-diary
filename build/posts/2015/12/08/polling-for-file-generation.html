<!DOCTYPE html>
<html lang="en">
  <head>
    
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üßë‚Äçüíª Kris Quigley  - Article </title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <link
      rel="stylesheet"
      href="/static/dist/css/output.css"
    />
    <link rel="stylesheet" href="/pygments.css" />
    <link
      rel="stylesheet"
      href="/static/node_modules/flowbite-typography/dist/typography.min.css"
    />
    
  </head>

  <body>
     <nav class="bg-white border-gray-200 dark:bg-gray-900">
  <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
    <a href="/" class="flex items-center">
      <span class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white">
        üßë‚Äçüíª Kris Quigley - Article 
      </span>
    </a>
    <button data-collapse-toggle="navbar-default" type="button"
      class="inline-flex items-center p-2 ml-3 text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600"
      aria-controls="navbar-default" aria-expanded="false">
      <span class="sr-only">Open main menu</span>
      <svg class="w-6 h-6" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20"
        xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd"
          d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
          clip-rule="evenodd"></path>
      </svg>
    </button>
    <div class="hidden w-full md:block md:w-auto" id="navbar-default">
      <ul
        class="font-medium flex flex-col p-4 md:p-0 mt-4 border border-gray-100 rounded-lg bg-gray-50 md:flex-row md:space-x-8 md:mt-0 md:border-0 md:bg-white dark:bg-gray-800 md:dark:bg-gray-900 dark:border-gray-700">
        <li>
          <a href="/"
            class="block py-2 pl-3 pr-4 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent">Posts</a>
        </li>
        <li>
          <a href="/about"
            class="block py-2 pl-3 pr-4 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent">About</a>
        </li>
      </ul>
    </div>
  </div>
</nav> 
    <main class="pt-8 pb-16 lg:pt-16 lg:pb-24 bg-white dark:bg-gray-900">
      <div class="flex justify-between px-4 mx-auto max-w-screen-xl">
        
<article
  class="mx-auto w-full max-w-2xl format format-sm sm:format-base lg:format-lg format-blue dark:format-invert"
>
  <header class="mb-4 lg:mb-6 not-format">
    <address class="flex items-center mb-6 not-italic">
      <div
        class="inline-flex items-center mr-3 text-sm text-gray-900 dark:text-white"
      >
        <div>
          <p class="text-base font-light text-gray-500 dark:text-gray-400">
            <time pubdate datetime="2015-12-08" title="2015-12-08"
              >Dec. 8, 2015</time
            >
          </p>
        </div>
      </div>
    </address>
    <h1
      class="mb-4 text-3xl font-extrabold leading-tight text-gray-900 lg:mb-6 lg:text-4xl dark:text-white"
    >
      Polling for File Generation
    </h1>
  </header>
  <h3>Background of the Problem</h3>
<p><img alt="Image of Orders Table" src="/static/images/orders.png" />
<em>A list of orders</em></p>
<p>We are currently generating a CSV of orders for a vendor; which at the moment isn't a big problem as we do not have many vendors, or many orders, so the CSV will generate relatively quickly.</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="n">OrdersController</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ApplicationController</span>
<span class="c1">#...</span>

<span class="n">def</span><span class="w"> </span><span class="n">download_csv</span>
<span class="w">    </span><span class="n">orders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Order</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="n">order_ids</span><span class="p">)</span>

<span class="w">    </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tempfile</span><span class="o">.</span><span class="n">new</span>

<span class="w">    </span><span class="n">CSV</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="o">|</span><span class="n">csv</span><span class="o">|</span>
<span class="w">    </span><span class="n">csv</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Address&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;City&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;County&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Postcode&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Email&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="n">orders</span><span class="o">.</span><span class="n">each</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="o">|</span><span class="n">order</span><span class="o">|</span>
<span class="w">        </span><span class="n">csv</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="o">.</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="o">.</span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="o">.</span><span class="n">county</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="o">.</span><span class="n">postcode</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="o">.</span><span class="n">email</span><span class="p">]</span>
<span class="w">    </span><span class="n">end</span>
<span class="w">    </span><span class="n">end</span>

<span class="w">    </span><span class="n">send_file</span><span class="w"> </span><span class="n">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
<span class="n">end</span>
<span class="n">end</span>
</code></pre></div>

<p>However, we know that suppliers and orders are bound to increase, therefore we need to find a better solution for generating files which will scale without blocking our precious ruby processes.</p>
<p>Obviously, this is where workers come in to do all the heavy lifting. By putting this work in a background process, we can free up our ruby processes again.</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="n">OrdersController</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ApplicationController</span>
<span class="c1">#...</span>

<span class="n">def</span><span class="w"> </span><span class="n">download_csv</span>
<span class="w">    </span><span class="n">GenerateCSVJob</span><span class="o">.</span><span class="n">perform_async</span><span class="p">(</span><span class="n">params</span><span class="p">[:</span><span class="n">order_ids</span><span class="p">])</span>

<span class="w">    </span><span class="c1"># Code to send file back to user</span>
<span class="n">end</span>
<span class="n">end</span>
</code></pre></div>

<p>However, how can I tell the controller that the file has finished being generated so that it can be sent back to the user?</p>
<h3>The Implementation</h3>
<p>It's at this point that we need to do some polling, and the purpose of writing this article.</p>
<p>Now that we have the controller calling the worker to generate the file we need a way of tracking the file generated. As we are not using a model for this we don't have any handy IDs to keep track, this is where I like to use timestamps instead.</p>
<p>require 'csv'</p>
<div class="codehilite"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nx">GenerateCSVJob</span>
<span class="nx">include</span><span class="w"> </span><span class="nx">Sidekiq</span><span class="o">::</span><span class="nx">Worker</span>

<span class="nx">def</span><span class="w"> </span><span class="nx">perform</span><span class="p">(</span><span class="nx">timestamp</span><span class="p">,</span><span class="w"> </span><span class="nx">order_ids</span><span class="p">)</span>
<span class="w">    </span><span class="nx">orders</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">Order</span><span class="p">.</span><span class="k">where</span><span class="p">(</span><span class="nx">id</span><span class="p">:</span><span class="w"> </span><span class="nx">order_ids</span><span class="p">)</span>

<span class="w">    </span><span class="nx">file</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">Tempfile</span><span class="p">.</span><span class="nx">new</span><span class="p">(</span><span class="nx">timestamp</span><span class="p">.</span><span class="nx">to_s</span><span class="p">)</span>

<span class="w">    </span><span class="nx">CSV</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;wb&quot;</span><span class="p">)</span><span class="w"> </span><span class="nx">do</span><span class="w"> </span><span class="o">|</span><span class="nx">csv</span><span class="o">|</span>
<span class="w">    </span><span class="nx">csv</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;Name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Address&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;City&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;County&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Postcode&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Email&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="nx">orders</span><span class="p">.</span><span class="nx">each</span><span class="w"> </span><span class="nx">do</span><span class="w"> </span><span class="o">|</span><span class="nx">order</span><span class="o">|</span>
<span class="w">        </span><span class="nx">csv</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">[</span><span class="nx">order</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">order</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span><span class="w"> </span><span class="nx">order</span><span class="p">.</span><span class="nx">city</span><span class="p">,</span><span class="w"> </span><span class="nx">order</span><span class="p">.</span><span class="nx">county</span><span class="p">,</span><span class="w"> </span><span class="nx">order</span><span class="p">.</span><span class="nx">postcode</span><span class="p">,</span><span class="w"> </span><span class="nx">order</span><span class="p">.</span><span class="nx">email</span><span class="p">]</span>
<span class="w">    </span><span class="nx">end</span>
<span class="w">    </span><span class="nx">end</span>

<span class="w">    </span><span class="nx">File</span><span class="p">.</span><span class="nx">rename</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/tmp/#{timestamp}_order.csv&quot;</span><span class="p">)</span>
<span class="nx">end</span>
<span class="nx">end</span>
</code></pre></div>

<p>Now that we have a unique way of identifying the file we have just generated, we have a clear way of identifying the file, in order to pass it back to the user.</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="n">OrdersController</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ApplicationController</span>
<span class="c1">#...</span>

<span class="n">def</span><span class="w"> </span><span class="n">download_csv</span>
<span class="w">    </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_i</span><span class="o">.</span><span class="n">to_s</span>

<span class="w">    </span><span class="n">GenerateCSVJob</span><span class="o">.</span><span class="n">perform_async</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">[:</span><span class="n">order_ids</span><span class="p">])</span>

<span class="w">    </span><span class="n">send_file</span><span class="w"> </span><span class="n">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;/tmp/#{timestamp}_order.csv&quot;</span><span class="p">)</span>
<span class="n">end</span>
<span class="n">end</span>
</code></pre></div>

<p>However, it is much cleaner if we just send back the entire URL for them to poll instead. At this point, that I want to clean up the <code>OrdersController</code> and move the logic into it's own controller instead.</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="n">CSVExportsController</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ApplicationController</span>
<span class="n">def</span><span class="w"> </span><span class="n">create</span>
<span class="w">    </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_i</span><span class="o">.</span><span class="n">to_s</span>

<span class="w">    </span><span class="n">GenerateCSVJob</span><span class="o">.</span><span class="n">perform_async</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">[:</span><span class="n">order_ids</span><span class="p">])</span>

<span class="w">    </span><span class="n">respond_to</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="o">|</span><span class="n">format</span><span class="o">|</span>
<span class="w">    </span><span class="n">format</span><span class="o">.</span><span class="n">json</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">render</span><span class="w"> </span><span class="n">json</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">url</span><span class="p">:</span><span class="w"> </span><span class="n">csv_export_path</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span><span class="w"> </span><span class="p">},</span>
<span class="w">                        </span><span class="n">status</span><span class="p">:</span><span class="w"> </span><span class="p">:</span><span class="n">ok</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="n">end</span>
<span class="n">end</span>
<span class="n">end</span>
</code></pre></div>

<p>Now we need to add an action to check whether the file exists yet or not, and if it does, then send it back to the user.</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="n">CSVExportsController</span> &lt; <span class="n">ApplicationController</span>
<span class="n">def</span> <span class="n">create</span>
    <span class="c1">#...</span>
<span class="nb">end</span>

<span class="n">def</span> <span class="n">show</span>
    <span class="n">timestamp</span> = <span class="nb">params</span>[:<span class="n">id</span>]
    <span class="k">if</span> <span class="n">File</span>.<span class="n">exist</span>?(<span class="s">&quot;/tmp/#{timestamp}_order.csv&quot;</span>)
    <span class="n">send_file</span> <span class="n">File</span>.<span class="nb">open</span>(<span class="s">&quot;/tmp/#{timestamp}_order.csv&quot;</span>) }
    <span class="k">else</span>
    <span class="nb">head</span> :<span class="n">not_found</span>
    <span class="nb">end</span>
<span class="nb">end</span>
<span class="nb">end</span>
</code></pre></div>

<p>However, I prefer to send a link back to the user which they can then use to download the file whenever they want.</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="n">CSVExportsController</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ApplicationController</span>
<span class="n">def</span><span class="w"> </span><span class="n">create</span>
<span class="w">    </span><span class="c1">#...</span>
<span class="n">end</span>

<span class="n">def</span><span class="w"> </span><span class="n">show</span>
<span class="w">    </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params</span><span class="p">[:</span><span class="n">id</span><span class="p">]</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">File</span><span class="o">.</span><span class="n">exist</span><span class="err">?</span><span class="p">(</span><span class="s2">&quot;/tmp/#{timestamp}_order.csv&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">respond_to</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="o">|</span><span class="n">format</span><span class="o">|</span>
<span class="w">        </span><span class="n">format</span><span class="o">.</span><span class="n">csv</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">send_file</span><span class="w"> </span><span class="n">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;/tmp/#{timestamp}_order.csv&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="n">format</span><span class="o">.</span><span class="n">json</span><span class="w"> </span><span class="n">do</span>
<span class="w">        </span><span class="n">render</span><span class="w"> </span><span class="n">json</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">file</span><span class="p">:</span><span class="w"> </span><span class="n">csv_export_path</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="p">:</span><span class="w"> </span><span class="p">:</span><span class="n">csv</span><span class="p">)}</span>
<span class="w">        </span><span class="n">end</span>
<span class="w">    </span><span class="n">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="n">head</span><span class="w"> </span><span class="p">:</span><span class="n">not_found</span>
<span class="w">    </span><span class="n">end</span>
<span class="n">end</span>
<span class="n">end</span>
</code></pre></div>

<p>But of course, none of this will work without the Ajax to marry it all up.</p>
<div class="codehilite"><pre><span></span><code><span class="p">((</span><span class="o">$</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="o">$</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="c1"># Provide some context to the user so they know what is happening after we submit the form</span>
<span class="w">    </span><span class="o">$</span><span class="p">(</span><span class="s1">&#39;button[data-behavior=&quot;generate_csv&quot;]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">click</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="o">$</span><span class="p">(</span><span class="s1">&#39;button[data-behavior=&quot;generate_csv&quot;]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
<span class="w">    </span><span class="o">$</span><span class="p">(</span><span class="s1">&#39;div[data-behavior=&quot;generating_csv&quot;]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="w">    </span><span class="o">$</span><span class="p">(</span><span class="s1">&#39;form[data-attribute=&quot;generate_csv_form&quot;]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="w"> </span><span class="s1">&#39;ajax:success&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">xhr</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="c1"># Uncheck the checkboxes</span>
<span class="w">    </span><span class="o">$</span><span class="p">(</span><span class="s1">&#39;input:checkbox&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">removeAttr</span><span class="p">(</span><span class="s1">&#39;checked&#39;</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># This will be our URL to check if the file exists</span>
<span class="w">    </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">url</span>

<span class="w">    </span><span class="c1"># Set up our polling object</span>
<span class="w">    </span><span class="n">poll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="o">$.</span><span class="n">ajax</span><span class="p">({</span>
<span class="w">        </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;GET&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">dataType</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;json&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="n">url</span><span class="p">:</span><span class="w">  </span><span class="n">url</span><span class="p">,</span>
<span class="w">        </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1"># If the file does not exist yet, try again</span>
<span class="w">            </span><span class="n">setTimeout</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">poll</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="mi">5000</span>
<span class="w">        </span><span class="n">success</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">xhr</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1"># Now that the file exists, populate the download link with the download URL and then show it</span>
<span class="w">            </span><span class="o">$</span><span class="p">(</span><span class="s1">&#39;div[data-behavior=&quot;generating_csv&quot;]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
<span class="w">            </span><span class="o">$</span><span class="p">(</span><span class="s1">&#39;a[data-attribute=&quot;download_csv_link&quot;]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
<span class="w">            </span><span class="o">$</span><span class="p">(</span><span class="s1">&#39;div[data-behavior=&quot;download_csv&quot;]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="w">        </span><span class="p">})</span>

<span class="w">    </span><span class="c1"># Start polling csv_export_path to see if the file exists yet</span>
<span class="w">    </span><span class="n">poll</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="p">)</span><span class="w"> </span><span class="n">jQuery</span>
</code></pre></div>

<p>The great thing about sending a URL back rather than just the file, is that we can add other formats to the <code>respond_to</code> block, if we ever need to generate other types of files. For example a PDF of order labels for the supplier to print and stick on their orders.</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="n">FileExportsController</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ApplicationController</span>
<span class="n">def</span><span class="w"> </span><span class="n">create</span>
<span class="w">    </span><span class="c1">#...</span>
<span class="n">end</span>

<span class="n">def</span><span class="w"> </span><span class="n">show</span>
<span class="w">    </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params</span><span class="p">[:</span><span class="n">id</span><span class="p">]</span>
<span class="w">    </span><span class="n">file_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">params</span><span class="p">[:</span><span class="n">file_type</span><span class="p">]</span><span class="w"> </span><span class="c1"># CSV, PDF, etc</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">File</span><span class="o">.</span><span class="n">exist</span><span class="err">?</span><span class="p">(</span><span class="s2">&quot;/tmp/#{timestamp}_order.#{file_type}&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="n">respond_to</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="o">|</span><span class="n">format</span><span class="o">|</span>
<span class="w">            </span><span class="n">format</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">file_type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">send_file</span><span class="w"> </span><span class="n">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;/tmp/#{timestamp}_order.#{file_type}&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">            </span><span class="n">format</span><span class="o">.</span><span class="n">json</span><span class="w"> </span><span class="n">do</span>
<span class="w">                </span><span class="n">render</span><span class="w"> </span><span class="n">json</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">file</span><span class="p">:</span><span class="w"> </span><span class="n">file_export_path</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="p">:</span><span class="w"> </span><span class="n">file_type</span><span class="p">,</span>
<span class="w">                                                                </span><span class="n">file_type</span><span class="p">:</span><span class="w"> </span><span class="n">file_type</span><span class="p">)}</span>
<span class="w">            </span><span class="n">end</span>
<span class="w">        </span><span class="n">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">head</span><span class="w"> </span><span class="p">:</span><span class="n">not_found</span>
<span class="w">    </span><span class="n">end</span>
<span class="n">end</span>
</code></pre></div>

<p>If you know of an alternative appraoch to achieving the same result, then please let me know in the comments below.</p>
<h3>Resources</h3>
<p>An example project with all the relavent code can be found under my <a href="https://github.com/krisquigley/poll-worker-for-changes">github</a> account.</p>
  <div id="disqus_thread"></div>
  <script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
    var disqus_config = function () {
      this.page.url = 'https://www.krisquigley.co.uk/posts/polling-for-file-generation.html'; // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = name; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };

    (function () {
      // DON'T EDIT BELOW THIS LINE
      var d = document,
        s = d.createElement('script');
      s.src = 'https://krisquigleycouk.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript
    >Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript"
      >comments powered by Disqus.</a
    ></noscript
  >
</article>


      </div>
    </main>
    <script src="/static/node_modules/flowbite/dist/flowbite.min.js"></script>
  </body>
</html>